# Implementation Plan

- [x] 1. Set up Capacitor plugin infrastructure
  - [x] 1.1 Create JavaScript plugin interface and registration
    - Create `lib/canvas-plugin.ts` with TypeScript interfaces
    - Define `CanvasPlugin` interface with `openCanvas()`, `clearCanvas()`, `hasContent()` methods
    - Register plugin with Capacitor using `registerPlugin()`
    - _Requirements: 6.1, 6.2_
  - [x] 1.2 Create native Swift plugin skeleton
    - Use `npm init @capacitor/plugin` to create a plugin and register it properly
    - Create `capacitor-canvas-plugin` with proper Swift implementation
    - Implement `CAPPlugin` subclass with `@objc` method stubs
    - Register plugin in Capacitor configuration
    - _Requirements: 6.2, 6.3_
  - [x] 1.3 Complete web plugin implementation
    - Implement all methods in `CanvasWeb` class with proper signatures
    - Return mock data for web testing
    - _Requirements: 6.1, 6.2_

- [x] 2. Implement native canvas view controller
  - [x] 2.1 Create CanvasViewController with PencilKit
    - Create `CanvasViewController` in Canvas.swift
    - Set up `PKCanvasView` with full-screen layout
    - Configure `PKToolPicker` for drawing tools
    - Implement delegate protocol for communication back to plugin
    - _Requirements: 1.1, 1.2, 1.3_
  - [x] 2.2 Implement canvas toolbar UI
    - Add submit button (sends drawing)
    - Add minimize button (dismisses without clearing)
    - Style toolbar for iPad
    - _Requirements: 2.1, 6.4_
  - [x] 2.3 Implement PNG export from PKDrawing
    - Convert `PKDrawing` to `UIImage`
    - Export as PNG data
    - Encode to base64 string
    - _Requirements: 2.1_

- [x] 3. Implement plugin bridge methods
  - [x] 3.1 Implement openCanvas() in Swift
    - Present `CanvasViewController` modally over web view
    - Handle delegate callbacks for submit/minimize/cancel
    - Resolve Capacitor promise with appropriate result
    - Support presentation styles (sheet/fullScreen)
    - _Requirements: 6.2, 6.3_
  - [x] 3.2 Implement canvas state preservation
    - Store `PKDrawing` in static property on minimize
    - Restore drawing when canvas reopens
    - Clear preserved state on submit or explicit clear
    - _Requirements: 6.5, 6.6_
  - [x] 3.3 Implement clearCanvas() in Swift
    - Clear preserved `PKDrawing` state
    - Clear current canvas if open
    - _Requirements: 3.1, 7.2_
  - [x] 3.4 Implement hasContent() in Swift
    - Check if preserved drawing has strokes
    - Return boolean result
    - _Requirements: 2.3, 6.5_

- [x] 4. Implement submission flow
  - [x] 4.1 Implement submit action in CanvasViewController
    - Validate canvas has content before allowing submit
    - Export PNG and return via delegate
    - Clear preserved state after successful submit
    - Dismiss view controller
    - _Requirements: 2.1, 2.2, 2.3, 6.7_

- [ ] 5. Write property-based tests for native functionality
  - [ ] 5.1 Write property test for PNG export validity
    - **Property 1: Export produces valid base64 PNG when canvas has content**
    - **Validates: Requirements 2.1**
  - [ ] 5.2 Write property test for submit clears state
    - **Property 2: Submit clears preserved canvas state**
    - **Validates: Requirements 2.2**
  - [ ] 5.3 Write property test for empty canvas prevents submission
    - **Property 3: Empty canvas prevents submission with image**
    - **Validates: Requirements 2.3**
  - [ ] 5.4 Write property test for clear removes content
    - **Property 5: Clear removes all canvas content**
    - **Validates: Requirements 3.1**
  - [ ] 5.5 Write property test for minimize/reopen round-trip
    - **Property 9: Minimize/reopen preserves drawing (round-trip)**
    - **Validates: Requirements 6.5, 6.6**

- [ ] 6. Integrate canvas plugin with chat UI
  - [x] 6.1 Create useCanvasPlugin hook
    - Wrap plugin methods in React hook
    - Track `isCanvasOpen` and `hasUnsavedContent` state
    - Handle plugin results and update chat
    - _Requirements: 6.1, 6.2_
  - [x] 6.2 Create ToggleCanvasButton component
    - Display pencil/canvas icon button
    - Show indicator when unsaved content exists
    - Call `openCanvas()` on click
    - _Requirements: 6.1_
  - [ ] 6.3 Implement canvas-first input area with keyboard toggle
    - Replace PromptInputTextarea with prominent "Open Canvas" button as the default input at bottom of chat
    - Display PromptInput.Footer below the canvas button (for images, websearch, model switching)
    - Add "Open Keyboard" button (small icon) in the footer area to toggle to text input mode
    - When in keyboard mode, show full PromptInput with PromptInputTextarea and a button to return to canvas mode
    - Handle canvas submission result and send image as message attachment
    - Preserve unsaved canvas content when switching between input modes
    - _Requirements: 2.4, 2.5, 6.1, 6.8, 6.9, 6.10, 6.11_

- [ ] 7. Implement message display for canvas images
  - [ ] 7.1 Update Message component to display images
    - Detect messages with image attachments
    - Render thumbnail of submitted canvas image
    - Support tap to expand image
    - _Requirements: 5.4_
  - [ ] 7.2 Style canvas message display
    - Thumbnail sizing and aspect ratio
    - Visual distinction from text messages
    - _Requirements: 5.4_

- [ ] 8. Implement conversation management
  - [ ] 8.1 Add new conversation button
    - Create button in chat header
    - Clear messages array on click
    - Call `clearCanvas()` to reset canvas state
    - _Requirements: 7.1, 7.2_

- [ ] 9. Implement auto-scroll behavior
  - [ ] 9.1 Implement auto-scroll on new message
    - Scroll to bottom when new message added
    - Only auto-scroll if user is at bottom
    - _Requirements: 5.2, 5.3_

- [ ] 10. Write property-based tests for UI functionality
  - [ ] 10.1 Write property test for submitted image in messages
    - **Property 4: Submitted image appears in messages**
    - **Validates: Requirements 2.4, 2.5**
  - [ ] 10.2 Write property test for auto-scroll behavior
    - **Property 6: Auto-scroll on new message**
    - **Validates: Requirements 5.2**
  - [ ] 10.3 Write property test for manual scroll pause
    - **Property 7: Manual scroll pauses auto-scroll**
    - **Validates: Requirements 5.3**
  - [ ] 10.4 Write property test for toggle opens canvas
    - **Property 8: Toggle button opens native canvas**
    - **Validates: Requirements 6.2**
  - [ ] 10.5 Write property test for submit closes canvas
    - **Property 10: Submit closes canvas and returns to chat**
    - **Validates: Requirements 6.7**
  - [ ] 10.6 Write property test for new conversation reset
    - **Property 11: New conversation resets all state**
    - **Validates: Requirements 7.1, 7.2**

- [ ] 11. Final integration and testing
  - [ ] 11.1 Verify streaming display works with canvas messages
    - Test AI response streaming after canvas submission
    - Ensure loader displays during streaming
    - Verify markdown rendering in responses
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [ ] 11.2 End-to-end manual testing
    - Test complete canvas submission flow
    - Verify image display in conversation
    - Test new conversation reset
    - Test auto-scroll behavior
    - _Requirements: All requirements_

- [ ] 12. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
